{% extends 'arbiter/base.html'%}
{% load static %}

{% block extrastyle %}
{{block.super}}
    <script src="{% static 'js/htmx.min.js' %}"></script>
    <script src="{% static 'js/plotly.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=1.3">
{% endblock %}
{% load humanize %}
{% block messages %}
<div id="message-container"></div>
{{ block.super }}
{% endblock %}
{% block content %}
<div class="dashboard">
    <div class="card">
        <h2 class="box-header">        
            <i class="fa-solid fa-server"></i> Management
        </h2>
        <div class="management-box">
            <div class="status-box">
                <h3>Status:</h3>
                <p><span class="code-name">cgroup-warden</span> instances up: {{ agents|length }}</p>
                <p>Last-Evaluated: {{last_evaluated | naturaltime}} </p>
            </div>

            <div class="commands-box">
                <div class="commands-list">
                    <form>
                        {% csrf_token %}
                        <h3>Run Arbiter Evaluation Loop:</h3>
                        <i class="helptext">
                            Use to run a single loop of evaluating arbiter's policies. Useful when testing for one off runs.
                        </i>
                        <input type="submit" value="Evaluate"
                            hx-post="{% url 'arbiter:evaluate' %}" hx-swap="afterbegin"
                            hx-target=".messagelist">
                    </form>
                    <hr class="box-divider">
                    <form>
                        {% csrf_token %}
                        <h3>Clean Violation History:</h3>
                        <i class="helptext">
                            Use to delete violation/event history before the specified time. 
                            Useful to clean state. Note the next evalutaion loop will fix any limits that are affected by this.
                        </i>
                        <div id="before-input">
                            <h4>Before:</h4><input type="datetime-local" name="before">
                        </div>
                        <input type="submit" value="Clean"
                            hx-post="{% url 'arbiter:clean' %}" hx-swap="afterbegin"
                            hx-include="[name='before']"
                            hx-target=".messagelist">
                    </form>
                </div>
            </div>

            <!-- <div class="apply-box">
                <form method="post" action="{% url 'arbiter:user-lookup' %}">
                {% csrf_token %}
                <h3>Quick Search</h3>
                <hr class="box-divider">
                <div class="options-box">
                    <div class="options-column">
                        <div class="label-input-box">
                            <h3>Username</h3>
                            <input type="text" name="user" placeholder="user">
                        </div>
                    </div>
                    <input type="submit" value="search">
                </div>
                </form>
            </div> -->
        </div>
    </div>
<div class="card">
    <h2 class="box-header"><i class="fa-solid fa-shield-halved"></i> Recent Violations</h2>
    <div class="notification-box">
        <table class="notification-table">
            <tbody>
                {% for violation in violations %}
                <tr>
                    <td>
                        <a href="{% url 'arbiter:change-violation' violation.id %}">
                            <p>{{violation}}</p>
                        </a>
                    </td>
                    <td>
                        <p>{{violation.timestamp | naturaltime}}</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="card">
    <h2 class="box-header"><i class="fa-solid fa-chart-line"></i> View Usage </h2>
    <div class="usage-box">
        <form>
            <div class="usage-options">
                <div class="options-column">
                    <div class="label-input-box">
                        <h3>Host:</h3>
                        <select required name="host" id="usage-host">
                            <option value="" disabled selected hidden>--Select--</option>
                            {% for host in agents %}
                            <option value="{{host}}">{{host}}</option>
                            {% empty %}
                                <option value="" disabled>No Hosts Found</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="label-input-box">
                        <h3>Username:</h3>
                        <input type="text" name="username" placeholder="" id="username">
                    </div>
                    <div class="label-input-box">
                        <h3>Step Size:</h3>
                        <span class="multi-select">
                            <input type="number" name="step-value" value="60">
                            <select name="step-unit">
                                <option value="s">Seconds</option>
                                <option value="m">Minutes</option>
                            </select>
                        </span>
                    </div>
                    <div class="label-input-box">
                        <h3>Start Time:</h3>
                        <input type="datetime-local" name="start-time">
                    </div>
                    <div class="label-input-box">
                        <h3>End Time:</h3>
                        <input type="datetime-local" name="end-time">
                    </div>
                    
                    <input type="button" value="View Memory" hx-get="{% url 'arbiter:user-proc-memory-graph' %}"
                        hx-swap="innerHTML" hx-target="#chart-div"
                        hx-vals="js:{...getPlotParams()}"
                        hx-include="[id='usage-user-input'], [id='usage-host'], [id='username'], [name='step-value'], [name='step-unit'], [name='end-time'], [name='start-time']">
                    <input type="button" value="View CPU" hx-get="{% url 'arbiter:user-proc-cpu-graph' %}" hx-swap="innerHTML"
                        hx-target="#chart-div"
                        hx-vals="js:{...getPlotParams()}"
                        hx-include="[id='usage-user-input'], [id='username'], [id='usage-host'], [name='step-value'], [name='step-unit'], [name='end-time'], [name='start-time']">
                </div>
            </div>
        </form>
        <hr class="box-divider">
        <div id="chart-div"></div>
    </div>
</div>
</div>
{% endblock %}
